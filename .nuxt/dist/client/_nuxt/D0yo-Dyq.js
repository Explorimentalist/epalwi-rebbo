import{indexedDBService as n}from"./DsNt8I1Z.js";import{searchService as h}from"./gbLrkHdn.js";import{r as s,L as g,Y as L,q as H,Z as O,$ as D}from"./3I7QIE0l.js";const l={CACHE_CHECK_INTERVAL:5*60*1e3,SEARCH_DEBOUNCE_MS:300,HISTORY_MAX_ITEMS:50,DEFAULT_SEARCH_LIMIT:20,DEFAULT_SEARCH_MODE:"hybrid",STORAGE_KEYS:{CURRENT_LANGUAGE:"epalwi-current-language",SEARCH_HISTORY:"epalwi-search-history",USER_PREFERENCES:"epalwi-preferences"}},a=L({initialized:!1,isLoading:!1,error:null,data:null,entries:[],index:null,cache:null});let d=null;function U(){const c=s("espa√±ol"),o=s([]),S=s(""),w=s([]),m=g(()=>a.initialized&&!a.isLoading);g(()=>{var e,t;return!!((t=(e=a.data)==null?void 0:e.entries)!=null&&t.length)}),g(()=>a.error);const p=g(()=>{var e;return((e=a.entries)==null?void 0:e.length)||0}),u=async()=>d||(d=v(),d),v=async()=>{if(!a.isLoading)try{a.isLoading=!0,a.error=null,console.log("üöÄ Initializing dictionary system..."),await n.initialize(),a.initialized||I();let e=null;try{const i=await $fetch("/api/dictionary");e=(i==null?void 0:i.version)||null,console.log(`üîç Current API version: ${e}`)}catch{console.warn("‚ö†Ô∏è Could not fetch API version for cache validation")}const t=await n.loadDictionaryData(),r=await n.getCacheMetadata();t&&r&&await n.isCacheValid(e??void 0)?(console.log("üìñ Using cached dictionary data"),await f(t,r,!0)):(a.initialized?console.log("üîÑ Cache invalid - refreshing dictionary data..."):console.log("üåê Loading dictionary from network..."),await R()),a.initialized=!0,a.isLoading=!1,console.log("‚úÖ Dictionary system initialized successfully")}catch(e){throw a.isLoading=!1,a.error=e instanceof Error?e.message:"Initialization failed",console.error("‚ùå Dictionary initialization failed:",e),e}},R=async()=>{try{const e=await $fetch("/api/dictionary");if(!e.success||!e.data)throw new Error(e.error||"Failed to load dictionary");const t=e.data;await n.storeDictionaryData(t);const r=await n.getCacheMetadata();return await f(t,r,!1),console.log(`‚úÖ Dictionary loaded from network: ${t.metadata.total_entries} entries`),t}catch(e){throw console.error("‚ùå Failed to load from network:",e),y("network-error","Failed to load dictionary from server",e)}},f=async(e,t,r)=>{a.data=e,a.cache=t;const i=await n.getEnhancedEntries();if(a.entries=i,await h.initialize(i),!r&&t&&!t.indexBuilt){const E=h.getIndexStats();E&&await n.storeSearchIndex(E)}console.log(`üìö Dictionary ready: ${i.length} searchable entries`)},A=async e=>{a.initialized||await u();try{const t=await h.search(e);return e.query.length>=2&&_(e.query),S.value=e.query,w.value=t,t}catch(t){throw console.error("‚ùå Search failed:",t),y("invalid-query","Search operation failed",t)}},C=async(e,t)=>{a.initialized||await u();try{return await h.autocomplete(e,t)}catch(r){return console.error("‚ùå Autocomplete failed:",r),[]}},_=e=>{const t=e.trim().toLowerCase();if(!t||t.length<2)return;const r=o.value.indexOf(t);r>-1&&o.value.splice(r,1),o.value.unshift(t),o.value.length>l.HISTORY_MAX_ITEMS&&(o.value=o.value.slice(0,l.HISTORY_MAX_ITEMS)),z()},I=()=>{try{const e=localStorage.getItem(l.STORAGE_KEYS.CURRENT_LANGUAGE);(e==="espa√±ol"||e==="ndowe")&&(c.value=e);const t=localStorage.getItem(l.STORAGE_KEYS.SEARCH_HISTORY);t&&(o.value=JSON.parse(t))}catch(e){console.warn("‚ö†Ô∏è Failed to load user preferences:",e)}},T=()=>{try{localStorage.setItem(l.STORAGE_KEYS.CURRENT_LANGUAGE,c.value)}catch(e){console.warn("‚ö†Ô∏è Failed to save user preferences:",e)}},z=()=>{try{localStorage.setItem(l.STORAGE_KEYS.SEARCH_HISTORY,JSON.stringify(o.value))}catch(e){console.warn("‚ö†Ô∏è Failed to save search history:",e)}},y=(e,t,r)=>{const i=new Error(t);return i.code=e,i.timestamp=Date.now(),r&&(i.originalError=r),i};return H(c,T),O(()=>{!a.initialized&&!d&&u().catch(e=>{console.error("‚ùå Auto-initialization failed:",e)})}),{isReady:m,isLoading:D(a,"isLoading"),error:s(null),currentLanguage:c,totalEntries:p,initialize:u,search:A,autocomplete:async(e,t="espa√±ol")=>await C(e,t),setLanguage:e=>{c.value=e},clearCache:async()=>{await n.clearCache()},getStats:async()=>({totalEntries:a.entries.length,espa√±olEntries:a.entries.length,ndoweEntries:a.entries.filter(e=>e.ndowe.length>0).length,entriesWithExplanations:a.entries.filter(e=>{var t;return(t=e.explicaci√≥n)==null?void 0:t.length}).length,entriesWithCrossReferences:a.entries.filter(e=>{var t;return(t=e.ver)==null?void 0:t.length}).length,averageTranslationsPerEntry:a.entries.reduce((e,t)=>e+t.ndowe.length,0)/a.entries.length,indexSizeBytes:0,cacheSizeBytes:0}),searchHistory:s([]),preferences:s({defaultLanguage:"espa√±ol",searchMode:"hybrid",maxResults:20,enableAutocomplete:!0,enableFuzzySearch:!0,showExplanations:!0,showCrossReferences:!0,theme:"light"})}}export{U as useDictionary};
